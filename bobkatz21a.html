<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BobKatz 21A by <span>gerald.katz</span></title>
<style>
    *,
*::before,
*::after {
  box-sizing: border-box;
}
body {
    overflow: hidden;
}
#header {
    position: absolute;
    top: 0px;
    left: 0px;
    right: 0px;
    background-color: #484848;
    height: 50px;
    font-size: 1.5em;
    font-variant: all-petite-caps;
    text-align: center;
    padding: 10px;
    color: #eaeaea;
}
#control_panel {
    position: absolute;
    top: 50px;
    left: 0px;
    background-color: #484848;
    padding: 0px;
    border: 2px solid #c1c1c1;
    border-top:none;
    border-left:none;
    border-bottom-right-radius:20px;
    width: 232px;
    overflow-x: clip;
    overflow-y: scroll;
    height: 95vh;
}
#control_panel div {
    margin: 10px;
    font-size: 1.2em;
    font-variant: all-petite-caps;
    color: #eaeaea;
    white-space: nowrap;
}
#control_panel input {
    width: 18%;
    margin-right: 10px;
    padding:0px;
}
select {
    border: none;
    padding: 0 1em 0 0;
    margin: 0;
    line-height: inherit;
    border: none;
    margin: 0;
    position: absolute;
    left: 28px;
    width: 180px;
    font-size: 0.75em;
}
select option {
    font-size: 0.75em;
}
#nav-buttons {
    position: absolute;
    right: 20px;
    top: 13px;
}
#nav-buttons button {
    font-size: .75em;
    color: white;
    font-weight: 700;
    font-variant: all-petite-caps;

}
#clear-colors,
#save-img,
#make-permalink { 
    display:none;
    background-color: #8e8e8e;
}
#clear-colors:hover
#save-img:hover,
#make-permalink:hover
 {
    background-color: #dfdede;
}
</style>
</head>
<body>
    <div id="header">
        BobKatz 21A
        <select id="theme-selector" autocomplete="off">
            <option value="defaults">Default</option>
            <!-- <option value="ctrlpew">CTRL+PEW</option> -->
            <!-- <option value="ivanthetroll">Ivan the Troll</option> -->
            <!-- <option value="jstark">JStark</option> -->
        </select>
        <a href="https://ctrlpew.com/" target="_blank" style="display:none;color: #132a13;background-color: white;padding: 10px;border-radius: 20px;text-decoration: none;">D/L on CTRLPEW.COM</a>
        <div id="nav-buttons">
            <button id="make-permalink">Make Permalink</button>
            <button id="save-img">Save Image</button>
            <button id="clear-colors">Clear</button>
        </div>
    </div>

    <div id="control_panel">
        <form id="model-colors">
            <div><input type="color" id="Body1006" name="Body1006" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF" >Bolt</div>
            <div><input type="color" id="Body1005" name="Body1005" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF" >Charging Handle Bushing</div>
            <div><input type="color" id="Body1001" name="Body1001" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF" >Ejector</div>
            <div><input type="color" id="Body2" name="Body2" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF">Buffer_Tube</div>
            <div><input type="color" id="Body1003" name="Body1003" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF">Feed_Ramp</div>
            <div><input type="color" id="Body1002" name="Body1002" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF">Barrel_Retainer</div>
            <div><input type="color" id="Body2001" name="Body2001" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF">Fire__Selector_Drum</div>
            <div><input type="color" id="Body1" name="Body1" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF">Magazine_Base_Plate</div>
            <div><input type="color" id="Body1004" name="Body1004" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF">Fire__Selector_Lever</div>
            <div><input type="color" id="Body1007" name="Body1007" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF">Magazine_Catch_Bar</div>
            <hr/>
            <div><input type="color" id="Background" name="Background" autocomplete="off" onchange="pickedColor(this)" value="#b7b7b7" >Background</div>
            <div style="display:none;"><input type="color" id="Floor" name="Floor" autocomplete="off" onchange="pickedColor(this)" value="#d9d9d9" >Floor</div>
        </form>
    </div>
<script>
var THREE, renderer, model, scene, texture, mats;
var parts = [];
var lights = [];

var themes = {
    defaults: {
        "Body1006":"#939393",
        "Body1005":"#011da1",
        "Body1001":"#011da1",
        "Body2":"#ff0000",
        "Body1003":"#ff0000",
        "Body1002":"#ff0000",
        "Body2001":"#011da1",
        "Body1":"#ff0000",
        "Body1":"#011da1",
        "Body1004":"#011da1",
        "Body1007":"#011da1"
    },
    backup: {
        "Barrel_Assembly":"#939393",
        "FGC-9 MkII Bolt Housing":"#011da1",
        "FGC-9 MkII Buffer Tube":"#011da1",
        "FGC-9 MkII Charging Handle":"#ff0000",
        "FGC-9 MkII Charging Handle Bushing":"#ff0000",
        "FGC-9 MkII Ejector":"#ff0000",
        "FGC-9 MkII Feed Ramp":"#011da1",
        "FGC-9 MkII Fire  Selector Drum":"#ff0000",
        "FGC-9 MkII Fire  Selector Lever":"#011da1",
        "FGC-9 MkII Lower Receiver":"#011da1",
        "FGC-9 MkII Magazine Base Plate":"#ff0000",
        "FGC-9 MkII Magazine Body":"#ff0000",
        "FGC-9 MkII Magazine Catch Bar":"#ff0000",
        "FGC-9 MkII Magazine Catch Button":"#ff0000",
        "FGC-9 MkII Magazine Catch Pivot Pin":"#011da1",
        "FGC-9 MkII Magazine Follower":"#011da1",
        "FGC-9 MkII Magazine Locking Tab":"#ff0000",
        "FGC-9 MkII Pistol Grip":"#ff0000",
        "FGC-9 MkII Pistol Grip Lid":"#ff0000",
        "FGC-9 MkII Stock":"#ff0000",
        "FGC-9 MkII Stock Butt Plate":"#ff0000",
        "FGC-9 MkII Top Rail":"#ff0000",
        "FGC-9 MkII Trigger":"#ff0000",
        "FGC-9 MkII Upper Receiver":"#ff0000"
    },
    clear: {
        "Barrel_Assembly":"#939393",
        "Fire_Selector_Assemby":"#FFFFFF",
        "Trigger":"#FFFFFF",
        "FGC-9_Buffer_Tube":"#FFFFFF",
        "FGC-9_Charging_Handle":"#FFFFFF",
        "FGC-9_Lower_Receiver":"#FFFFFF",
        "FGC-9_Stock":"#FFFFFF",
        "FGC-9_Upper_Receiver_Rail":"#FFFFFF",
        "FGC-9_Upper_Receiver":"#FFFFFF",
        "FGC-9_Pistol_Grip":"#FFFFFF",
        "FGC-9_Barrel_Retainer_Oversized_Shaft_Collar_Pocket":"#FFFFFF",
        "Bolt_Carrier_fgc9_mki_v1_Body1_Bolt_Carrier":"#FFFFFF",
        "Ejector_Pivot_fgc9_mki_v1_Body1_Ejector_Pivot":"#FFFFFF",
        "Ejector_fgc9_mki_v1_Body1_Ejector":"#FFFFFF",
        "Magazine_Catch_Assembly_fgc9_mki_v1_Magazine_Catch_Bar_1_Body1_":"#FFFFFF",
        "Magazine_fgc9_mki_v1_Magazine_Body_1_Body1_Magazine_Body":"#FFFFFF"
    }
};

function getColorFormData() {
    var form = document.getElementById('model-colors');
    return Object.values(form).reduce((obj,field) => { obj[field.name] = field.value; return obj }, {});
}

function makePermalink() {
    var data = getColorFormData();
    var str = window.btoa(JSON.stringify(data));
    window.history.pushState(data,("FGC9 "+new Date().getTime()),('https://mountainman1776.github.io/3d_coloring//?design='+str));
}

function logKey(e) {
    var steps = 2;
    if(e.code=="ArrowUp") {
        // camera.position.z = camera.position.z+steps;
        camera.position.y = camera.position.y+steps;
    } else if(e.code=="ArrowDown") {
        // camera.position.z = camera.position.z-steps;
        camera.position.y = camera.position.y-steps;
    } else if(e.code=="ArrowLeft") {
        camera.position.x = camera.position.x-steps;
    } else if(e.code=="ArrowRight") {
        camera.position.x = camera.position.x+steps;
    } else {
        console.log(` ${e.code}`);
    }
}

function setDefaults(firstLoad) {
    var themeSelectorElm = document.getElementById('theme-selector');
    console.log('themeSelectorElm.value',themeSelectorElm.value);
    var theme = themes[themeSelectorElm.value];
    if(firstLoad) {
        var params = QueryStringToJSON();
        if(params.hasOwnProperty('design')) {
            console.log('params.design',params.design);
            try {
                var data = JSON.parse(window.atob(params.design));
                updateColors(data);
            } catch(e) {
                console.log(e);
            }
        } else {

            updateColors(theme);
        }
    } else {
        updateColors(theme);
    }
}

function updateColors(theme) {
    console.log('updateColors',theme);
    var values = Object.keys(theme);
    for(var va in values) {
        var prop = values[va];
        var val = theme[prop];
        console.log(prop,val);
        try {
            var elm = document.getElementById(prop);
            elm.value = val;
            updateElementColor(prop,val);
        } catch(e) {

        }
    }
}

function pickedColor(elm) {
    // console.log(elm);
    if(elm.name=="Background") {
        scene.background = new THREE.Color(elm.value);
    }else if(elm.name=="Floor") {
        scene.background = new THREE.Color(elm.value);
    } else {

        updateElementColor(elm.name,elm.value)
    }
}

function updateElementColor(name,color) {
    // parts[0].material = new THREE.MeshStandardMaterial({color: 0xff4400});
    var elm = findElementByName(name);
    if(elm) {
        const material = new THREE.MeshPhysicalMaterial({color: color});
        // const material = new THREE.MeshPhysicalMaterial();
        // material.color = color;
        material.clearcoat = 0.5;
        material.metalness = 0.1;
        material.roughness = .34;
        material.reflectivity = 0.08;
        material.transmission = 0.1;
        material.clearcoatRoughness = 0.7;
        material.flatShading = true;
        material.ior = .2;
        elm.material = material;
        // elm.material = materialnew THREE.MeshStandardMaterial({color: color});
    }
}

function findSceneObjectByName(name) {
    for(var scn in scene.children) {
        var sceneObj = scene.children[scn];
        if(sceneObj.type=='Group') {
            for(var grp in sceneObj.children) {
                var sceneGroup = sceneObj.children[grp];
                if(name==sceneGroup.name) {
                    return sceneGroup;
                }
            }
        }
    }
    return null;
}

function findElementByName(name) {
    for(var prt in parts) {
        var part = parts[prt];
        // console.log(part.name,name,(part.name==name));
        // console.log(part.name);
        console.log(`<div><input type="color" id="${part.name}" name="${part.name}" autocomplete="off" onchange="pickedColor(this)" value="#FFFFFF" >${part.name}</div>`)
        if(part.name==name) {
            return part;
        }
    };
    return null;
}

function saveAsImage() {
        var imgData, imgNode;

        try {
            var strMime = "image/jpeg";
            var strDownloadMime = "image/octet-stream";
            imgData = renderer.domElement.toDataURL(strMime);
            saveFile(imgData.replace(strMime, strDownloadMime), "fgc9_designs.jpg");

        } catch (e) {
            console.log(e);
            return;
        }

    }

    var saveFile = function (strData, filename) {
        var link = document.createElement('a');
        if (typeof link.download === 'string') {
            document.body.appendChild(link); //Firefox requires the link to be in the body
            link.download = filename;
            link.href = strData;
            link.click();
            document.body.removeChild(link); //remove the link when done
        } else {
            location.replace(uri);
        }
    }

    function QueryStringToJSON() {            
        var pairs = location.search.slice(1).split('&');
        
        var result = {};
        pairs.forEach(function(pair) {
            pair = pair.split('=');
            result[pair[0]] = decodeURIComponent(pair[1] || '');
        });

        return JSON.parse(JSON.stringify(result));
    }
</script>
<script type="module">
import * as THREE from "./js/three.module.js";
import {GLTFLoader} from './js/GLTFLoader.js'
import { OrbitControls } from "./js/OrbitControls.js";
import { DRACOLoader } from './DRACOLoader.js'

var mesh, renderer, scene, camera, controls, model;

init();

function init() {
    window.THREE = THREE;
    const BACKGROUND_COLOR = 0xb7b7b7;
    // renderer
    renderer = new THREE.WebGLRenderer({preserveDrawingBuffer: true});
    window.renderer = renderer;
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.setPixelRatio( window.devicePixelRatio );
    document.body.appendChild( renderer.domElement );

    window.addEventListener('resize', function() {
        var width = window.innerWidth
        var height = window.innerHeight
        renderer.setSize(width, height);
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
    });

    // scene
    scene = new THREE.Scene();
    renderer.shadowMap.enabled = true;
    window.scene = scene;

    scene.background = new THREE.Color(BACKGROUND_COLOR );
    // scene.fog = new THREE.Fog(BACKGROUND_COLOR, 20, 100);

    //scene floor
    // var floorMaterial = new THREE.MeshBasicMaterial( { color: '#d9d9d9', side: THREE.DoubleSide } );
    // var floorGeometry = new THREE.PlaneGeometry(400, 400, 1, 1);
    // let floor = new THREE.Mesh(floorGeometry, floorMaterial);
    // // floor.position.y = -0.5;
    // floor.position.y = -100;
    // floor.rotation.x = Math.PI / 2;
    // floor.name = "Floor";
    // scene.add(floor);

    // camera
    camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 );
    // camera.position.set( 260, 120, 1.1 );
    camera.position.set( 250, 100, 140 );
    window.camera = camera;

    // controls
    controls = new OrbitControls( camera, renderer.domElement );
    controls.screenSpacePanning = true;
    
    // ambient
    var amLight = new THREE.AmbientLight( 0xFFFFFF, .5 );
    // window.amLight = amLight;
    // amLight.castShadow = true;
    scene.add(amLight);
    lights.push(amLight);
    
    // light
    var light = new THREE.DirectionalLight( 0xffffff, 0.5 );
    light.position.set( 120,120, 120 );
    light.castShadow = true;
    scene.add( light );
    lights.push(light);

    var light1 = new THREE.DirectionalLight( 0xffffff, 0.5 );
    light1.position.set( -120,-120, 120 );
    light1.castShadow = true;
    scene.add( light1 );
    lights.push(light1);

    
    const light2 = new THREE.DirectionalLight( 0xc1c1c1, 0.5 );
    light2.castShadow = true;
    scene.add( light2 );
    lights.push(light2);

    var pointLight = new THREE.PointLight(0xffffff, 0.15);
    pointLight.position.set(0, 3, 0);
    scene.add(pointLight);

    
let model;
let loader = new GLTFLoader();
let modelName = "21a_sample_003.gltf";

loader.setDRACOLoader( new DRACOLoader() );



loader.load(modelName, function(gltf){
    model = gltf.scene;
    model.scale.set(0.5,0.5,0.5);
    model.position.y = -50;
    model.position.x = 0;
    model.position.z = 0;
    model.castShadow = true;
    // model.position.z = -100;
    // model.quaternion.set(0,0,0,0);
    // model.rotation.x = -0.14;
    // model.rotation.y = -3.25;
    window.model = model;

    gltf.scene.traverse( ( object ) => {
        // console.log(object);
        if ( object.isMesh ) {
            object.material.color.set( 0xffffff * Math.random() );
            console.log(object.name);
            // object.material = new THREE.MeshStandardMaterial({color: 0xffffff * Math.random()});
            object.material = new THREE.MeshStandardMaterial({color: 0xffffff});
            // object.material = texMat;
            parts.push(object);
            // writeText("FGC9");
        }
    } );

//     var mixer = new THREE.AnimationMixer( gltf.scene );
// var clip = gltf.animations[ 0 ];
// var action = mixer.clipAction( clip );
// action.clampWhenFinished = true;
// action.play();


  scene.add(gltf.scene);
  setDefaults(true);
  animate();
});

function animate() {
    requestAnimationFrame( animate );
    if(controls){ 
        controls.update();
    }
    if(renderer) {
        renderer.render( scene, camera );
    }
    if(model) {
        if(model.rotation.y<0.5) {
            model.rotation.y += 0.01;
        }
    }
}

    
}



    </script>
    <script>
        document.addEventListener('keydown', logKey);
        document.getElementById('make-permalink').addEventListener('click', function (event) {
            makePermalink();
        });
        document.getElementById('save-img').addEventListener('click', function (event) {
            saveAsImage();
        });
        document.getElementById('clear-colors').addEventListener('click', function (event) {
            updateColors(themes.clear);
        });
        document.getElementById('theme-selector').addEventListener('change', function (event) {
            setDefaults();
        });
    </script>
</body>
</html>
